(function(e){e(document).ready((function(){e("#select-folder").click((function(){e("#folder-picker").css("display","block");e("#folder-picker .sp-folder-picker").fileTree({script:ShortPixel.browseContent,multiFolder:false})}));e("#select-backup-folder").click((function(){if(e("#folder").val().length>0){e("#backup-folder-picker").css("display","block");e("#backup-folder-picker .sp-folder-picker").fileTree({script:ShortPixel.browseContent,multiFolder:false,onlyFolders:true})}else{alert("Please select folder to optimize first.")}}));e("#folder-picker .sp-popup input.select-folder-cancel").click((function(){e("#folder-picker").css("display","none")}));e("#backup-folder-picker .sp-popup input.select-folder-cancel").click((function(){e("#backup-folder-picker").css("display","none")}));e("#folder-picker .sp-popup input.select-folder").click((function(){var i=e("#folder-picker UL.jqueryFileTree LI.directory.selected A").attr("rel");if(i){var t=i;if(t.slice(-1)=="/")t=t.slice(0,-1);e("#folder").val(t);e(".specific-options-msg").remove();var r=ShortPixel.getFolderOptions({folder:i});if(typeof r==="object"){if(typeof r.lossy!=="undefined"){e("#type-"+(r.lossy==1?"lossy":"lossless")).prop("checked",true);e("#removeExif").prop("checked",r.keep_exif==0?true:false);e("#cmyk2rgb").prop("checked",r.cmyk2rgb==1?true:false);e("#resize").prop("checked",r.resize&1?true:false);e("#width").val(r.resize_width);e("#height").val(r.resize_height);e("#resize_type_"+(r.resize&2?"inner":"outer")).prop("checked",true);e("#webp").prop("checked",r.convertto.indexOf("+webp")>=0?true:false);e("#avif").prop("checked",r.convertto.indexOf("+avif")>=0?true:false);e("#exclude").val(r.exclude);e("#backup_path").val(r.backup_path);e('<div class="specific-options-msg"><h3 class="success" id="info-message">Folder-specific options loaded, please check below.</h3>'+"</div>").insertBefore("#options-header")}if(typeof r.base_url!="undefined"){e("#base_url").val(r.base_url);e("#info_message span").html("Base URL: "+r.base_url);e("#info_message").css("display","block")}else if(typeof r.base_url_detected!="undefined"){e("#detected_base_url").val(r.base_url_detected);e("#confirm_message").css("display","block")}}e("#folder-picker").css("display","none")}else{alert("Please select a folder from the list.")}}));e("#btn_ignore").click((function(){e("#base_url").val(e("#detected_base_url").html());e("#info_message").css("display","none");e("#confirm_message").css("display","none");ShortPixel.addCronSuggestion(".specific-options-msg",e("#folder").val(),false)}));e("#btn_confirm").click((function(){e(".base-url-msg").remove();var i=e("#detected_base_url").val();e("#info_message span").html("Base URL: "+i);e("#info_message").css("display","");e("#base_url").val(i);e("#confirm_message").css("display","none");ShortPixel.addCronSuggestion(".specific-options-msg",e("#folder").val(),i)}));e("#backup-folder-picker .sp-popup input.select-folder").click((function(){var i=e("#backup-folder-picker UL.jqueryFileTree LI.directory.selected A").attr("rel");if(i){var t=ShortPixel.utsi(i);var r=e("#folder").val();if(t.indexOf(ShortPixel.tsi(r))!==-1){t="ShortPixelBackups"}else{t=ShortPixel.pathToRelative(t,r)}e("#backup_path").val(t);e("#backup_path").trigger("change");e("#backup-folder-picker").css("display","none")}else{alert("Please select a folder from the list.")}}));e("#backup_path").change((function(i){var t=e(i.target).val().trim();if(t.indexOf("..")!==0&&t.lastIndexOf("ShortPixelBackups")!==t.length-17){e("#backup_path").val(t+(t.length?"/":"")+"ShortPixelBackups")}}));e(".sp-folder-tree-results").fileTree({root:e("#sp-folder-path").val(),script:ShortPixel.browseContentExt,multiFolder:false},(function(e){}),(function(e){}));e(document).on("click",".optimized-view",(function(t){t.preventDefault();var r=e(this).attr("data-optimized");console.log("I clicked the eye");var o=r.substring(r.indexOf(window.location.host)+window.location.host.length);i(o+"/")}));e("#uploadCompareSideBySide").on("click",(function(i){if(i.target==this){e("#uploadCompareSideBySide").hide().removeClass("in sp-shade");e("#modal-loading").show()}}));e("#uploadCompare").on("click",(function(i){if(i.target==this){e("#uploadCompare").hide();e("#compareSlider").unwrap();e("#compareSlider").html("");e("#modal-loading").show()}}));e(".modal-content .close").on("click",(function(i){e("#uploadCompare").hide();e("#uploadCompareSideBySide").hide().removeClass("in");e("#compareSlider").unwrap();e("#compareSlider").html("");e("#modal-loading").show()}));ShortPixel.enableResize("#resize");e("#resize").change((function(){ShortPixel.enableResize(this)}))}));function i(i){var t=e("#uploadCompare");var r=e(`a[rel='${i}'`).siblings(".sp-file-status").children(".optimized-view");console.log(i);e("#compareSlider").html('<img class="uploadCompareOriginal"/><img class="uploadCompareOptimized"/>');var o=e(".uploadCompareOptimized",t);var s=e(".uploadCompareOriginal",t);s.attr("src",r.data("original"));o.attr("src",r.data("optimized"));s.on("load",(function(){e(window).trigger("resize")}));o.on("load",(function(){e(window).trigger("resize");var i=this.width;var o=this.height;var s=o<150||i<350;if(s){var l=Math.max(350,Math.min(800,i<350?(i+25)*2:o<150?i+25:i));var n=Math.max(150,i>350?2*(o+45):o+45);t=e("#uploadCompareSideBySide");t.addClass("in sp-shade");e(".modal-dialog",t).css("width",l);e(".shortpixel-slider",t).css("width",l);e(".modal-body",t).css("height",n);t.show();e(".side-by-side .uploadCompareOriginal").attr("src",r.data("original"));e(".side-by-side .uploadCompareOptimized").attr("src",r.data("optimized"))}else{var a=Math.max(800,Math.round(.8*Math.max(document.documentElement.clientWidth,window.innerWidth||0)));var l=Math.max(350,Math.min(a,i<350?(i+25)*2:o<150?i+25:i));var n=o*l/i;e(".modal-dialog",t).css("width",l).css("max-width",i);e(".shortpixel-slider",t).css("width",l).css("max-width",i);e(".modal-body",t).css("height",n);t.show();e("#compareSlider").twentytwenty({slider_move:"mousemove"});e("#modal-loading").hide()}}));setTimeout((function(){e(window).trigger("resize")}),1e3)}})(jQuery);var spSlice=10;var errCount=0;var ShortPixel=function(){function e(e){return t(e,"false")}function i(e){return t(e,"true")}function t(e,i){e.action="shortpixel_browse_content";e.extended=i;var t="";jQuery.ajax({type:"POST",url:window.location,data:e,success:function(e){t=e},async:false});return t}function r(e,i){var t=i.replace(/^\//,"").split("/");var r=e.replace(/^\//,"").split("/");var o=[];for(var s=0,l=true;s<Math.max(t.length,r.length);s++){if(l&&typeof t[s]!=="undefined"&&typeof r[s]!=="undefined"&&t[s]==r[s])continue;l=false;if(typeof t[s]!=="undefined")o.unshift("..");if(typeof r[s]!=="undefined")o.push(r[s])}return o.join("/")}function o(e){e.action="shortpixel_folder_options";var i="";jQuery.ajax({type:"POST",url:window.location,data:e,success:function(e){i=e},async:false});try{return JSON.parse(i)}catch(e){return{}}}function s(e,i,t){$(e).html($(e).html()+'<p class="code-advice">You can also optimize this folder by configuring a job in the crontab like this:<br>'+"<code>0,15,30,45 * * * * runuser -l "+ShortPixel.CURRENT_OS_USER+" -s /bin/sh -c 'php "+ShortPixel.OS_PATH+"/"+ShortPixel.OWN_SUBFOLDER+"/vendor/shortpixel/shortpixel-php/lib/cmdShortpixelOptimize.php --apiKey="+ShortPixel.API_KEY+" --folder="+ShortPixel.OS_PATH+i+"'</code></p>")}function l(e,i){$.ajax({type:"POST",url:window.location.href.split("?")[0],data:{action:"shortpixel_optimize",unique_id:ShortPixel.UNIQUE_ID,folder:e,slice:i},success:function(i){errCount==Math.max(0,errCount-1);try{var t=JSON.parse(i)}catch(t){console.log("Unrecognized response, retrying in 10 sec. ("+i+")");setTimeout((function(){l(e,spSlice)}),1e4);return}if(t.status.code<0){if($("#error-message").length>0){$("#error-message").html(t.status.message)}else{$('<div><h3 class="error" id="error-message">'+t.status.message+"</h3></div>").insertBefore("#totalFiles")}if(t.status.code!=-403){setTimeout((function(){l(e,spSlice)}),15e3)}return}if(t.status.code==2){window.location.reload()}else if(t.status.code==1){$("#error-message").html("");if(t.succeeded.length+t.pending.length+t.same.length+t.failed.length==0){if(ShortPixel.emptyConsecutiveResponses>3||p==100){if(ShortPixel.sliderConsumerId!==false){clearInterval(ShortPixel.sliderConsumerId);ShortPixel.sliderConsumerId=false}window.location.reload();return}ShortPixel.emptyConsecutiveResponses++}else{ShortPixel.emptyConsecutiveResponses=0}var r=t.succeeded.concat(t.same);for(var o=0,s=0;s<r.length;s++){var d=r[s];if(ShortPixel.sliderHistory.find(d.OriginalURL)>=0){continue}o++;if(d.OriginalURL.split(".").pop().toLowerCase()!=="pdf"){d.imageOrig=new Image;d.imageOpt=new Image;d.imageOrig.src=d.OriginalURL;d.imageOpt.src=d.LossyURL}ShortPixel.sliderQueue.enqueue(d);ShortPixel.sliderHistory.enqueue(d.OriginalURL)}for(var c=0,s=0;s<t.failed.length;s++){ShortPixel.sliderHistory.enqueue(t.failed[s].OriginalURL)}$("#doneFiles").val(parseInt($("#doneFiles").val())+o+t.failed.length+t.same.length);var p=Math.min(100,100*parseInt($("#doneFiles").val())/parseInt($("#totalFiles").val()));n(p.toFixed(1),"");if(ShortPixel.sliderConsumerId===false){ShortPixel.sliderConsumerId=setInterval(a,ShortPixel.sliderFrequencyMs)}ShortPixel.addCronSuggestion(".progress-code-advice-empty",e,false);$(".progress-code-advice").removeClass("progress-code-advice-empty");$(".progress-code-advice").parent().css("min-height",""+Math.max(600,window.innerHeight-$(".progress-code-advice").parent().offset().top-100)+"px");var u=typeof t.source!=="undefined"?1e4:1e3;setTimeout((function(){l(e,spSlice)}),u)}else if(t.status.code==0){setTimeout((function(){l(e,spSlice)}),1e4)}},error:function(i,t,r){if(t==="timeout"){console.log("got timeout, retrying in 10 sec...")}else{console.log("got error "+t+", retrying in 10 sec...")}if(errCount>4){errCount=0;spSlice=Math.max(1,Math.round(spSlice/2))}else{errCount+=2}setTimeout((function(){l(e,spSlice)}),1e4)}})}function n(e,i){var t=$("#bulk-progress");if(t.length){$(".progress-left",t).css("width",e+"%");$(".progress-img",t).css("left",e+"%");if(e>24){$(".progress-img span",t).html("");$(".progress-left",t).html(e+"%")}else{$(".progress-img span",t).html(e+"%");$(".progress-left",t).html("")}jQuery(".bulk-estimate").html(i)}}function a(){var e=ShortPixel.counter++;var i=ShortPixel.sliderQueue.dequeue();if(typeof i==="undefined")return;if(typeof i.imageOpt!=="undefined"&&!i.imageOpt.complete)return;if(typeof i==="undefined"){ShortPixel.sliderFrequencyMs+=500;return}if(ShortPixel.sliderQueue.getLength()>15){if(ShortPixel.sliderFrequencyMs>=2500){ShortPixel.sliderFrequencyMs-=500}else{ShortPixel.sliderQueue.dequeue()}}var t=i.PercentImprovement;var r=i.SavedFile?i.SavedFile:i.SavedFileUTF8;var o=r.split("/").pop();var s=o.split(".").pop().toLowerCase();var l=s==="pdf"?"img/logo-pdf.png":i.LossyURL;var n=s==="pdf"?"img/logo-pdf.png":i.OriginalURL;var a=jQuery(".bulk-slider div.bulk-slide:first-child");if(a.attr("id")!="empty-slide"){a.hide()}a.css("z-index",1e3);$(".bulk-img-opt",a).attr("src","");if(n.length>0){$(".bulk-img-orig",a).attr("src","")}var d=a.clone();d.attr("id","slide-"+e);$(".bulk-img-opt",d).attr("src",l);if(n.length>0&&t>0){$(".img-original",d).css("display","inline-block");$(".bulk-img-orig",d).attr("src",n)}else{$(".img-original",d).css("display","none")}$(".bulk-opt-percent",d).html('<input type="text" class="dial" value="'+t+'"/>');$(".img-info-optimized",d).css("display",t>0?"inline-block":"none");$(".img-info-same",d).css("display",t>0?"none":"inline-block");$(".bulk-slider").append(d);ShortPixel.percentDial("#"+d.attr("id")+" .dial",100);$(".bulk-slider-container span.filename").html("&nbsp;&nbsp;"+o);if(a.attr("id")=="empty-slide"){a.remove();$(".bulk-slider-container").css("display","block")}else{a.animate({left:a.width()+a.position().left},"slow","swing",(function(){jQuery(".bulk-slider div.bulk-slide:not(:last-child)").remove();d.fadeIn("slow")}))}}function d(){jQuery(".bulk-slider-container").css("display","none")}function c(e,i){jQuery(e).knob({readOnly:true,width:i,height:i,fgColor:"#1CAECB",format:function(e){return e.toFixed(1)+"%"}})}function p(e){if($(e).is(":checked")){$("#width,#height").removeAttr("disabled")}else{$("#width,#height").attr("disabled","disabled")}}function u(e){return e+(e.endsWith("/")?"":"/")}function f(e){if(e.slice(-1)=="/")e=e.slice(0,-1);return e}return{counter:0,sliderQueue:new Queue(100),sliderHistory:new Queue(300),sliderConsumerId:false,sliderFrequencyMs:3e3,emptyConsecutiveResponses:0,browseContent:e,browseContentExt:i,getFolderOptions:o,pathToRelative:r,addCronSuggestion:s,optimize:l,progressUpdate:n,sliderUpdate:a,hideSlider:d,percentDial:c,enableResize:p,tsi:u,utsi:f}}();function Queue(e){var i=[];var t=0;var r=typeof e!=="undefined"?e:1e5;this.getLength=function(){return i.length-t};this.isEmpty=function(){return i.length==0};this.enqueue=function(e){i.push(e);if(i.length>r){this.dequeue()}};this.dequeue=function(){if(i.length==0)return undefined;var e=i[t];if(++t*2>=i.length){i=i.slice(t);t=0}return e};this.peek=function(){return i.length>0?i[t]:undefined};this.find=function(e){for(var t=0;t<i.length;t++){if(e==i[t]){return t}}return-1}}